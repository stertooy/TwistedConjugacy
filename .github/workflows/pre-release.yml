name: Pre-release
on:
  - workflow_dispatch

jobs:

  test-pkg:
    name: "Test package (version: ${{ matrix.gap-version }}, mode: ${{ matrix.mode }})"
    uses: ./.github/workflows/test-pkg.yml
    with:
      gap-version: ${{ matrix.gap-version }}
      mode: ${{ matrix.mode }}
      coverage: false
      warnings-as-errors: ${{ matrix.mode != 'loadall' }}
    strategy:
      fail-fast: false
      matrix:
        gap-version: [ "4.14.0", "4.15.0", "4.15.1", "master" ]
        mode: [ "onlyneeded", "default", "loadall" ]

  test-gap:
    name: "Test GAP (version: ${{ matrix.gap-version }}, mode: ${{ matrix.mode }})"
    uses: ./.github/workflows/test-gap.yml
    with:
      gap-version: ${{ matrix.gap-version }}
      mode: ${{ matrix.mode }}
      complete: ${{ matrix.mode != 'loadall' }}
      warnings-as-errors: ${{ matrix.mode != 'loadall' }}
    strategy:
      fail-fast: false
      matrix:
        gap-version: [ "4.14.0", "4.15.0", "4.15.1", "master" ]
        mode: [ "onlyneeded", "default", "loadall" ]

  deps:
    name: "Test dependency conflicts"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    container:
      image: ghcr.io/stertooy/gda-image:master-slim

    steps:

      - name: "Checkout"
        uses: actions/checkout@v5

      - name: "Add custom GAP root"
        run: ln -f -s $PWD /tmp/gaproot/pkg/

      - name: "Verify that tests do not depend on PrimGrp/SmallGrp/TransGrp"
        shell: bash
        run: gap --bare -c 'LoadPackage("GAPDoc");LoadPackage("Polycyclic");TestPackage("TwistedConjugacy");'

      - name: "Verify that we do not interfere with Polycyclic's tests"
        shell: bash
        run: gap -A -c 'LoadPackage("Polycyclic");LoadPackage("TwistedConjugacy");TestPackage("Polycyclic");'

  lint:
    name: "Run gaplint"
    uses: ./.github/workflows/lint.yml

  release-test:
    name: "Dry run of Release"
    uses: ./.github/workflows/release.yml
    with:
      dry-run: true
